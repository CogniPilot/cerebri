/* SPDX-License-Identifier: Apache-2.0 */
/* Copyright 2025 CogniPilot Foundation */

/*
 * ESC Passthrough FlexIO UART configuration for VMU
 *
 * Motor output pins (using FlexIO1 for hardware UART):
 *   CH0 = GPIO_EMC_06 = FlexIO1 pin 6
 *   CH1 = GPIO_EMC_07 = FlexIO1 pin 7
 *   CH2 = GPIO_EMC_08 = FlexIO1 pin 8
 *   CH3 = GPIO_EMC_09 = FlexIO1 pin 9
 *
 * Uses FlexIO peripheral for half-duplex single-wire UART at 19200 baud
 * instead of GPIO bit-banging. This provides:
 *   - More accurate timing (hardware-generated baud rate)
 *   - Less CPU overhead (no busy-wait loops)
 *   - Better noise immunity
 *
 * Communication:
 *   Passthrough: USB-C CDC ACM (/dev/ttyACM0)
 *   Console: lpuart1 debug cable (/dev/ttyUSB0)
 */

/* Pinmux for FlexIO UART mode on ESC pins */
&pinctrl {
	pinmux_flexio_esc: pinmux_flexio_esc {
		group0 {
			pinmux = <&iomuxc_gpio_emc_06_flexio1_flexio06>,
				<&iomuxc_gpio_emc_07_flexio1_flexio07>,
				<&iomuxc_gpio_emc_08_flexio1_flexio08>,
				<&iomuxc_gpio_emc_09_flexio1_flexio09>;
			drive-strength = "r0-6";
			slew-rate = "fast";
			nxp,speed = "100-mhz";
			bias-pull-up;  /* Keep line HIGH when in RX mode (high-Z) */
		};
	};
};

&flexio1 {
	status = "okay";

	flexio_uart_esc: flexio_uart_esc {
		compatible = "nxp,flexio-uart";
		status = "okay";
		pinctrl-0 = <&pinmux_flexio_esc>;
		pinctrl-names = "default";
		current-speed = <19200>;

		/* ESC channels - each uses one FlexIO shifter/timer pair */
		ch0 { pin-id = <6>; };   /* ESC1 - GPIO_EMC_06 */
		ch1 { pin-id = <7>; };   /* ESC2 - GPIO_EMC_07 */
		ch2 { pin-id = <8>; };   /* ESC3 - GPIO_EMC_08 */
		ch3 { pin-id = <9>; };   /* ESC4 - GPIO_EMC_09 */
	};
};

/* CDC ACM UART for ESC passthrough (new USB stack) */
&zephyr_udc0 {
	cdc_acm_uart0: cdc_acm_uart0 {
		compatible = "zephyr,cdc-acm-uart";
	};
};

/* Disable PWM outputs that would conflict with GPIO control */
&flexpwm1_pwm1 {
	status = "disabled";
};

&flexpwm1_pwm2 {
	status = "disabled";
};

&flexpwm2_pwm0 {
	status = "disabled";
};
